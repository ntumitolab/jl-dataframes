jupyter_book_task:
  only_if: $CIRRUS_BRANCH == $CIRRUS_DEFAULT_BRANCH || $CIRRUS_BASE_BRANCH == $CIRRUS_DEFAULT_BRANCH
  env:
    JOBS: 8
    TIMEOUT: 600
    GH_TOKEN: ENCRYPTED[0146fcd58e501a847f528c70d9449f831de345227a4cdc1cd7c8407559938e6cb203fa51ab5c828f2d0e97b40931f1fa]
  auto_cancellation: true
  container:
    dockerfile: .github/cirrus.Dockerfile
    cpu: 4
    memory: 16G
    greedy: true
  notebook_script: >
    parallel --joblog /tmp/log -j${JOBS}
    jupyter nbconvert --to notebook
    --ExecutePreprocessor.timeout=${TIMEOUT}
    --ExecutePreprocessor.kernel_name="julia-1.$(julia -e 'print(VERSION.minor)')"
    --execute --inplace --allow-errors
    {} ::: docs/*.ipynb
  execution_results_script:  cat /tmp/log
  build_script: |
    jupyter-book build docs/ --keep-going
  # Requires a repo scope access `GH_TOKEN` PAT to push
  pages_script: |
    if [[ $CIRRUS_BRANCH == $CIRRUS_DEFAULT_BRANCH ]]; then
      git remote set-url origin https://${GH_TOKEN}@github.com/${CIRRUS_REPO_FULL_NAME}.git
      ghp-import -n -p -f docs/_build/html
    fi
